
# 浅谈App的启动优化

## 应用启动的方式

在Android中，应用启动一般可分为三种：**冷启动**、**温启动**、**热启动**。

那么什么是**冷启动**、**温启动**和**热启动**呢？下面我们来简单看一下它们的定义：

* 冷启动：当启动应用时，后台没有该应用的进程。这时系统会又一次创建一个新的进程分配给该应用，这个启动方式就是冷启动。

* 温启动：当启动应用时，后台已有该应用的进程，但是Activity可能因为内存不足被回收。这样系统会从已有的进程中来启动这个Activity，这个启动方式叫温启动。

* 热启动：当启动应用时，后台已有该应用的进程，且Activity仍然存在内存中没有被回收。这样系统直接把这个Activity拉到前台即可，这个启动方式叫热启动。

由于冷启动相对于其他启动方式多了进程的创建（Zygote进程fork创建进程）以及应用的资源加载和初始化（Application的创建及初始化），所以相对来说会比较耗时，所以我们一般说的App启动优化一般指的都是App的冷启动优化。

## 优化方案

App启动优化的本质就是：不要让用户等待太长的时间。这就好比早些年你去饭店吃饭，你想要点餐但等了半天都没有服务人员过来，可能就等得不耐烦直接走开了。同样的，对于APP来说，如果用户点击App后长时间都打不开，用户就很可能失去耐心而卸载应用。

所以**启动速度是用户对我们App的第一体验**。如果启动速度过慢，用户第一印象就会很差，这样即使你功能做出花来，用户也不会愿意去使用。

其实要想优化App的启动体验，关键就是要让用户更快地获取到应用的内容（流畅，不卡顿、不等待），那么我们应该怎么做呢？

### 案例分析

这里我们还是先以之前说的去饭店吃饭为例来展开讨论。现在的饭店竞争是尤为得激烈，为了能够提高顾客的体验、留住顾客，真的是使出了浑身解数，除了口味之外，服务品质也是被摆在了越来越重要的位置。

就比方说：

* 为了能够更快地给用户提供点餐服务，现在的饭店每个座子上基本都贴上了点餐的二维码。
* 一些热门需要排队的餐馆，在前台张贴了二维码，提供排队取号和提前点餐服务。
* 一些常年爆满需要排队的餐馆，还提供了零食、茶水、棋牌以及美甲等服务。
* 有些餐厅为了提高上菜的速度和体验，设置了倒计时免单的服务。

以上的改进措施，都是这些年餐饮行业在竞争下，不断提高服务质量的产物。可以说谁的服务质量落下了，谁就有可能被淘汰。

其实我们仔细分析一下上面所列举的，不难看出有很多是可以让我们借鉴的。

（1）**分析**：饭店提供了点餐的二维码，本质上是将一件被动等待转变为主动请求的一种过程，客观上减少了等待的时间，从而提高了速度。
    **类比**：这对应我们的应用程序，就像原先一些耗时不必要的三方库需要被动等待其初始化完毕程序才会继续进行，转变为先不初始化这部分耗时的三方库，等真正用到时再进行初始化；又类似我们应用程序的游客模式，无需被迫进行一堆复杂的用户注册过程，就可以直接进入程序使用，待涉及一些用户信息功能的时候再提示用户注册。

（2）**分析**：热门餐馆同时提供排队取号和提前点餐服务，本质上是将原先无法同时进行的操作（需要先排上队等到座位，才能扫描座位号点餐）变成了可同时进行的操作，将串行任务转化为并行任务，从而节省了时间。
    **类比**：这对应我们的应用程序，就是将一些原本在主线程串行执行的耗时资源/数据加载，改为在子线程中并发执行。这在几个耗时任务耗时差距不大的时候优化尤为明显。

（3）**分析**：在顾客排队等待的时候，提供零食、茶水、棋牌以及美甲等服务，本质上就是让顾客提前享受本餐馆的服务，从而缓解顾客等待的焦虑。
    **类比**：这对应我们的应用程序，就是开屏启动页。在Android12上，Google强制增加了这个开屏页，就是为了让用户提前看到你的应用页面，让用户产生应用启动很流畅的假象，从而提高用户的启动体验。

（4）**分析**：设置倒计时免单服务，本质上就是给等待加上了进度条上限以及超时赔偿。俗话说最让人害怕的是等待，比等待更让人害怕的是看不见尽头的等待。而为等待设置上限，可以极大地缓解顾客等待的焦虑，毕竟等待超时了也是会有补偿的。
    **类比**：这对应我们的应用程序，就是一些应用（比如游戏）初次启动会非常耗时，所以它们通常会在启动页增加一个初始化/加载进度条页面，来告诉用户啥时候能加载完，而不是无止境未知的等待。

通过分析，我们可以看到（1）、（2）两种操作是从技术的角度来实现的优化，而（3）、（4）两种操作则更多的是从业务的角度去实现的优化。

### 优化策略

从上面的案例分析，我们可以得出，应用启动优化，我们可以分别从技术和业务的角度来进行决策。

#### 技术优化

（1）针对启动流程任务进行梳理。
    * 无耗时任务 -> 主线程
    * 耗时且需要同步任务 -> 异步线程 + 同步锁
    * 耗时且无需同步任务 -> 异步线程
（2）非必要不执行。
    * 非必要数据 -> 懒加载
    * 非必要任务 -> 延迟/空闲执行
    * 非必要界面/布局 -> 延迟加载
    * 非必要功能 -> 删除/插件化
（3）数据结构优化，减小初始化时间。
    * 数据结构尽可能复用，避免内存抖动
    * 数据结构申请的空间要恰到好处，不能过大（占用空间，创建慢）也不能过小（频繁扩充，效率低）
    * 重要的资源本地缓存

#### 业务优化

（1）业务流程整合。
    * 多个相关的串行业务整合为统一的一个业务。
    * 不相关的串行业务整合为并行的业务。

（2）业务流程拆分调整。
    * 对业务进行拆分，拆分出主要（必要）业务和次要（非必要）业务。
    * 分别对主要业务和次要业务进行优先级评估，业务执行按优先级从高到底依次执行。

### 优化方向

在优化之前，让我们先来分析一下冷启动的过程：

Zygote创建应用进程 -> AMS请求ApplicationThread -> Application创建 -> attachBaseContext > onCreate -> ActivityThread启动Activity -> Activity生命周期(创建、布局加载、屏幕布置、首帧绘制)

以上过程，只有Application和Activity的生命周期这两个阶段对我们来说是可控的，所以这就是我们的优化方向。

### 优化措施

#### 启动流程优化

1.依据之前我们列举的技术优化策略，首先需要对启动的所有任务流程进行梳理，然后对其执行方式进行优化。

* 只有必要且非耗时的任务在`主线程`执行。
* 耗时且需要同步的任务，使用`异步线程 + 同步锁`的方式执行。
* 耗时且无需同步的任务在`异步线程`执行。

2.第三方SDK初始化优化。

* 对于那些在启动时非必要的第三方SDK，可以延迟初始化。
* 对于初始化耗时的第三方SDK，可以开启一个后台服务/异步线程进行初始化。

3.网络请求优化。

* 启动过程中避免不必要的网络请求。对于那些在启动时非必要执行的网络请求，可以延时请求或者使用缓存。
* 对于需要进行多次串行网络请求的接口进行优化整合，控制好请求接口的粒度。比如后台有获取用户信息的接口、获取用户推荐信息的接口、获取用户账户信息的接口。这三个接口都是必要的接口，且存在先后关系。如果依次进行三次请求，那么时间基本上都花在网络传输上，尤其是在网络不稳定的情况下耗时尤为明显。但如果将这三个接口整合为获取用户的启动（初始化）信息，这样数据在网络中传输的时间就会大大节省，同时也能提高接口的稳定性。

4.磁盘IO优化

* 启动过程中避免不必要的磁盘IO操作。这里的磁盘IO包括：文件读写、数据库（sqlite）读写和SharePreference等。
* 对于启动过程中所必须的数据加载，选择合适的数据结构。可以选择支持随机读写、延时解析的数据存储结构以替代SharePreference。
* 启动过程中避免大量的序列化和反序列化。

#### 线程优化










































> 我是xuexiangjys，一枚热爱学习，爱好编程，勤于思考，致力于Android架构研究以及开源项目经验分享的技术up主。获取更多资讯，欢迎微信搜索公众号：**【我的Android开源之旅】**
